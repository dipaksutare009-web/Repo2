# ✅ FIXED GitHub Actions Workflow to Auto-Sync Sub Folder from Repo1
# This version resolves: "could not read Username for 'https://github.com'"
# Cause: PAT not being correctly applied during checkout authentication

name: Auto Sync Sub Folder from Repo1

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

env:
  SRC_REPO: dipak0008/Repo1
  SRC_BRANCH: Foundation-only
  DEST_BRANCH: main
  SUB_PREFIX: Sub

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: ✅ Checkout Repo2 (FIXED AUTH)
      uses: actions/checkout@v4
      with:
        repository: dipaksutare009-web/Repo2
        ref: main
        token: ${{ secrets.REPO2_SYNC_TOKEN }}
        fetch-depth: 0

    - name: Configure git user
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

    - name: ✅ Add Repo1 as remote using PAT
      run: |
        git remote add repo1 https://x-access-token:${{ secrets.REPO2_SYNC_TOKEN }}@github.com/${{ env.SRC_REPO }}.git
        git fetch repo1 ${{ env.SRC_BRANCH }}

    - name: ✅ Sync Sub Folder using Subtree
      run: |
        if [ ! -d "${{ env.SUB_PREFIX }}" ]; then
          git subtree add --prefix=${{ env.SUB_PREFIX }} repo1 ${{ env.SRC_BRANCH }} --squash
        else
          git subtree pull --prefix=${{ env.SUB_PREFIX }} repo1 ${{ env.SRC_BRANCH }} --squash
        fi

    - name: ✅ Push changes to Repo2
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.REPO2_SYNC_TOKEN }}@github.com/${{ github.repository }}.git
        git push origin HEAD:${{ env.DEST_BRANCH }}
